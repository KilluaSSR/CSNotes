# IPv6 

## IPv6 相比 IPv4 的主要变化

1. **更大的地址空间**：从 32 位扩展到 128 位，极大增加了可用地址数量
2. **扩展的地址层次结构**：更灵活的层次结构，提高路由和管理效率
3. **灵活的首部格式**：采用可选的扩展首部处理不同网络需求
4. **改进的选项机制**：选项信息被放置在数据报的有效载荷部分
5. **协议扩展性**：设计允许进一步扩展，适应未来需求
6. **支持即插即用**：支持设备自动配置，不再完全依赖 DHCP
7. **支持资源预分配**：为实时应用提供带宽和时延保障
8. **首部对齐方式变化**：从 IPv4 的 4 字节对齐改为 8 字节对齐

## 1. 扩展首部处理

- **扩展首部设计**：IPv6 将选项功能移至扩展首部，主要由源站和目的站处理
- **路由器处理减少**：除逐跳选项扩展首部外，中间路由器不处理扩展首部，显著提高了处理效率
## 2. IPv6 数据报目的地址类型

- **单播 (Unicast)**：点对点通信，一个发送者到一个接收者
- **多播 (Multicast)**：一点对多点通信，发送给一组指定接收者
- **任播 (Anycast)**：IPv6 新增类型，发送给一组计算机中的一个（通常是最近的）
## 3. IPv6 地址格式与表示

- **地址长度**：128 位，约 3.4×10³⁸ 个可用地址
- **表示方法**：冒号十六进制记法，每 16 位用十六进制表示，用冒号分隔
  - 例如：`68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF`

**简化记法**：
- **零压缩**：连续的零可用 `::` 代替（每个地址只能用一次）
  - 例如：`FF05:0:0:0:0:0:0:B3` → `FF05::B3`
- **省略前导零**：每组中的前导零可省略
  - 例如：`0000` → `0`
## 4. IPv6 特殊地址

1. **未指明地址（全零地址）**
   - 表示为 `0:0:0:0:0:0:0:0` 或 `::`
   - 仅用于源地址，表示主机尚未配置标准 IP 地址

2. **环回地址**
   - 表示为 `0:0:0:0:0:0:0:1` 或 `::1`
   - 类似 IPv4 的 `127.0.0.1`，用于本机通信和测试

3. **零压缩示例**
   - 原始：`0000:1234:0000:0000:0000:0000:0000:0003`
   - 压缩后：`::1234:0:0:0:0:0:3` 或 `0:1234::3`

## 5. IPv6 向 IPv4 过渡策略

### 双协议栈

- 主机同时支持 IPv4 和 IPv6 两种协议
- 根据通信对象选择使用相应协议
- 通过 DNS 返回的地址类型决定使用哪种协议
- 缺点：可能造成信息损失

### 隧道技术

- 允许 IPv6 数据包通过现有 IPv4 网络传输
- 接收方可以完整保留发送方的流标号等信息

#### 隧道技术工作原理

1. **封装**：IPv6 数据包被封装在 IPv4 数据包的有效载荷中
2. **传输**：通过 IPv4 网络传输封装后的数据包
3. **解封装**：目标端解封装，恢复原始 IPv6 数据包并处理

#### 隧道技术实现方式

1. **6to4 隧道**
   - 将 IPv6 地址映射到 IPv4 地址
   - 例如：IPv6 地址 `2002:0A0A:0A0A::/48` 对应 IPv4 地址 `10.10.10.10`

2. **Teredo 隧道**
   - 允许 NAT 后的 IPv6 主机与 IPv6 网络通信
   - 通过 UDP 封装在 IPv4 网络中传输

3. **ISATAP**
   - 为企业内部网络设计的隧道技术
   - 为每个 IPv6 主机分配与 IPv4 地址关联的 IPv6 地址

4. **手动隧道**
   - 管理员手动配置隧道端点
   - 适用于连接两个无直接 IPv6 连接的 IPv6 网络

#### 隧道技术优缺点

**优点**：
- 支持 IPv6 在现有 IPv4 网络上传输
- 允许逐步过渡到 IPv6
- 提高 IPv4 与 IPv6 网络互通性

**缺点**：
- 封装/解封装带来性能开销
- 配置管理较复杂
- 可能带来安全风险

## 6. IPv6 与 CIDR

- IPv6 继续支持 CIDR 表示法
- 例如：`12AB:0000:0000:CD30:0000:0000:0000:0000/60` 表示前 60 位为网络前缀

# 中继设备与IP协议

**1. 中间设备（中继设备）**

- 又称为中继系统或中间系统。
    
- 不同层次的中继设备：
    
    - **物理层中继**：转发器（Repeater）
        
    - **数据链路层中继**：网桥（Bridge）、交换机（Switch）
        
    - **网络层中继**：路由器（Router）
        
    - **网络层以上中继**：网关（Gateway）
        
- **中继设备的作用**：
    
    - **转发器/网桥**：仅扩大网络范围，仍然是一个单一网络。
        
    - **路由器**：互联不同的网络，形成互联网。
        

**2. 互联网**

- 通过路由器进行网络互连。
    
- **直接交付**：无需路由器。
    
- **间接交付**：需要路由器。
    

**3. IP 协议和相关协议**

- **IP 协议**：是 TCP/IP 协议栈中的核心协议，负责寻址和路由。
    
- 与 IP 协议配套使用的四个协议：
    
    1. **ARP（地址解析协议）**：将IP地址解析为MAC地址。
        
    2. **RARP（逆地址解析协议）**：将MAC地址解析为IP地址。
        
    3. **ICMP（因特网控制报文协议）**：用于错误报告和网络诊断（如Ping命令）。
        
    4. **IGMP（因特网组管理协议）**：用于管理主机组播。

# IP地址

- 每个连接到因特网上的主机或路由器都有一个唯一的**32位IP地址**，**采用点分十进制表示法**（如：192.168.0.1）。
    
- **IP 地址结构**：
    
    - **网络号（net-id）**：标识该主机所在的网络。
        
    - **主机号（host-id）**：标识主机或路由器。


IP 地址共分为五个主要类别（A、B、C、D、E类），其中前三类用于常规网络通信：

### 1. A 类地址
- **地址范围**：1.0.0.0 ~ 127.255.255.255
- **网络位/主机位**：8位/24位
- **默认子网掩码**：255.0.0.0 (/8)
- **高位识别**：以 `0` 开头
- **适用场景**：大型网络（支持约1677万主机）

### 2. B 类地址
- **地址范围**：128.0.0.0 ~ 191.255.255.255
- **网络位/主机位**：16位/16位
- **默认子网掩码**：255.255.0.0 (/16)
- **高位识别**：以 `10` 开头
- **适用场景**：中型网络（支持65534个主机）

### 3. C 类地址
- **地址范围**：192.0.0.0 ~ 223.255.255.255
- **网络位/主机位**：24位/8位
- **默认子网掩码**：255.255.255.0 (/24)
- **高位识别**：以 `110` 开头
- **适用场景**：小型网络（支持254个主机）

### 4. D 类地址
- **地址范围**：224.0.0.0 ~ 239.255.255.255
- **高位识别**：以 `1110` 开头
- **用途**：多播/组播地址

### 5. E 类地址
- **地址范围**：240.0.0.0 ~ 255.255.255.255
- **高位识别**：以 `1111` 开头
- **用途**：保留地址，用于实验和未来扩展

## IP 地址类型判断

### 网络地址判断
网络地址是指主机位全为0的地址，用于标识整个网络段。

- **A类网络地址**：主机部分（后24位）全为0
  - 例如：`10.0.0.0`
- **B类网络地址**：主机部分（后16位）全为0
  - 例如：`172.16.0.0`
- **C类网络地址**：主机部分（后8位）全为0
  - 例如：`192.168.1.0`

### 广播地址判断
广播地址是指主机位全为1的地址，用于向网络中所有主机发送数据。

- **A类广播地址**：主机部分（后24位）全为1
  - 例如：`10.255.255.255`
- **B类广播地址**：主机部分（后16位）全为1
  - 例如：`172.16.255.255`
- **C类广播地址**：主机部分（后8位）全为1
  - 例如：`192.168.1.255`

### 单播地址判断
单播地址是指在网络地址和广播地址之间的有效主机地址。

- **A类单播地址**：网络位固定，主机位不全为0也不全为1
  - 例如：`10.1.1.1`
- **B类单播地址**：网络位固定，主机位不全为0也不全为1
  - 例如：`172.16.1.1`
- **C类单播地址**：网络位固定，主机位不全为0也不全为1
  - 例如：`192.168.1.1`

## 快速识别技巧

1. **观察第一个字节**：
   - 1-127：A类地址
   - 128-191：B类地址
   - 192-223：C类地址
   - 224-239：D类地址
   - 240-255：E类地址

2. **二进制观察**：
   - 首位为0：A类地址
   - 首两位为10：B类地址
   - 首三位为110：C类地址
   - 首四位为1110：D类地址
   - 首四位为1111：E类地址

## 路由与网络层

在数据传输过程中，路由功能确实是在**网络层**实现的。网络层负责确定数据从源到目的地的路径，而路由器在网络层工作，决定如何将数据包转发到目标网络。

### 1. **同一个局域网上的主机或路由器的 IP 地址中的网络号必须是一样的**

这是正确的。

- **原因**：在一个局域网（LAN）中，所有设备的 **网络号** 必须相同。网络号决定了设备是否在同一个网络中。如果主机或设备的网络号不同，它们就不属于同一个局域网，它们之间的通信就需要经过路由器转发。
    
- **举个例子**：

    - 假设有两个主机，分别为 `192.168.1.10` 和 `192.168.1.20`，它们的 **网络号** 都是 `192.168.1`，因此它们位于同一个局域网中，可以直接进行通信。
        
    - 如果其中一个主机的 IP 地址是 `192.168.2.10`，那么它的 **网络号** 就是 `192.168.2`，这时它不在同一个局域网内，通信时必须通过路由器。
        

### 2. **路由器总是具有两个或两个以上的 IP 地址**

这是正确的。

- **原因**：路由器通常连接多个网络，因此需要有多个接口，每个接口都具有一个属于不同网络的 IP 地址。这使得路由器能够在不同的网络之间进行通信。
    
- **举个例子**：
    
    - 假设一个路由器有两个接口，一个连接到 `192.168.1.0/24` 网络，另一个连接到 `10.0.0.0/24` 网络。那么这个路由器的两个接口就会分别拥有不同的 IP 地址，例如 `192.168.1.1` 和 `10.0.0.1`，它们分别属于不同的网络。
        

### 3. **路由器的每一个接口都有一个不同网络号的 IP 地址**

这也是正确的。

- **原因**：每个路由器接口都连接到一个不同的网络，因此每个接口的 IP 地址都必须具有不同的网络号。每个接口的网络号不同，这样路由器就能够识别哪些数据包属于哪个网络，并根据网络号将数据包转发到正确的接口。
    
- **举个例子**：
    
    - 路由器接口 1：`192.168.1.1`（属于 `192.168.1.0/24` 网络）
        
    - 路由器接口 2：`10.0.0.1`（属于 `10.0.0.0/24` 网络）
        
    
    这样，路由器就能够根据 IP 数据包的目标地址决定应该通过哪个接口转发数据包。
    


- 在同一局域网上，主机或路由器的 **网络号** 必须相同，这样它们才能在同一个网络中进行直接通信。
    
- 路由器通常具有两个或多个接口，每个接口都有不同的 **IP 地址**，并且每个接口的 IP 地址属于不同的 **网络号**，以便进行跨网络的通信

- 在 IP 数据报在网络上进行转发时，通常会发生以下变化：

	- **源 IP 地址** 和 **目的 IP 地址** 在转发过程中 **不会变化**。因为这两个字段的主要作用是标识数据报的源主机和目标主机，而这些信息应该保持不变，直到数据报到达目的地。
	    
	- **源 MAC 地址** 和 **目的 MAC 地址** 则会发生变化，因为它们是与数据链路层的设备（如交换机、路由器等）相关的。每次数据报经过一个新的网络段时，源和目的 MAC 地址会更新，以反映不同网络上的设备。

# ARP

> 已知 IP 地址，如何找出其相应的硬件地址（MAC 地址）？


ARP（地址解析协议）是用于在 **局域网（LAN）** 中，将 **IP 地址** 映射为 **硬件地址**（例如 **MAC 地址**）的协议。无论网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终都必须使用硬件地址。
**注：在OSI模型里ARP属于链路层，但是在TCP/IP中属于网络层**
### **ARP 的工作原理：**

1. **主机 A 向主机 B 发送数据**：
    
    - 当主机 A 向本局域网的主机 B 发送数据报时，主机 A 需要知道主机 B 的 **硬件地址（MAC 地址）**。
        
    - **ARP 高速缓存**：首先，主机 A 会在自己的 ARP 高速缓存中查找主机 B 的 IP 地址对应的 MAC 地址。
        
        - 如果找到了，直接使用缓存中的 MAC 地址，将数据包封装在 MAC 帧中发送。
            
        - 如果没有找到，主机 A 会发送 **ARP 请求**，请求主机 B 反馈其 MAC 地址。
            
2. **ARP 请求**：
    
    - ARP 请求是一个 **广播** 消息，发送到整个局域网。
        
    - ARP 请求内容包括主机 A 的 IP 地址和硬件地址，以及目标主机 B 的 IP 地址。
        
3. **ARP 响应**：
    
    - 主机 B 收到 ARP 请求后，会发送 **ARP 响应**，在响应中包含主机 B 的 MAC 地址。
        
    - 主机 A 收到响应后，将主机 B 的 IP 地址和 MAC 地址映射存入自己的 ARP 高速缓存中。
        
    - 主机 B 也会将主机 A 的 IP 地址和 MAC 地址映射存入自己的 ARP 高速缓存中。
        
4. **ARP 高速缓存**：
    
    - ARP 高速缓存用于保存已解析的 IP 地址和 MAC 地址映射表。这样可以减少网络通信量，避免每次通信都需要广播 ARP 请求。
        
    - 每个 ARP 映射项通常有生存时间（TTL），如果在TTL过期后没有被访问，该项映射会被删除。
        

### **典型的 ARP 使用情况：**

ARP 主要用于以下四种典型情况：

1. **主机发送数据到同一局域网的另一个主机**：
    
    - 发送方是主机 A，目标是局域网内的主机 B。此时，主机 A 会使用 ARP 查找主机 B 的硬件地址。
        
2. **主机发送数据到另一个网络上的主机**：
    
    - 发送方是主机 A，目标是另一个网络上的主机 B。此时，主机 A 会通过 ARP 查找一个路由器的硬件地址（该路由器位于主机 A 的局域网内），并将数据包发送给这个路由器，由路由器完成后续的转发工作。
        
3. **路由器转发数据到同一局域网的主机**：
    
    - 发送方是路由器，目标是局域网内的主机。路由器会通过 ARP 查找目标主机的硬件地址，然后将数据包转发给该主机。
        
4. **路由器转发数据到另一个网络上的主机**：
    
    - 发送方是路由器，目标是另一个网络上的主机。此时，路由器会通过 ARP 查找本网络内的另一个路由器的硬件地址，然后将数据包发送给该路由器，由这个路由器完成后续的转发工作。
        

### **ARP 请求和响应示例：**

假设：

- **主机 A 的 IP 地址** 是 `209.0.0.5`，**MAC 地址** 是 `00:00:CO:15:AD:18`。
    
- **主机 B 的 IP 地址** 是 `209.0.0.6`，**MAC 地址** 是 `08:00:2B:00:EE:0A`。
    

1. **ARP 请求**：
    
    - 主机 A 想要与主机 B 通信，首先会广播发送 ARP 请求，询问 `209.0.0.6` 的 MAC 地址。
        
2. **ARP 响应**：
    
    - 主机 B 收到 ARP 请求后，会返回一个 ARP 响应，告知主机 A 自己的 MAC 地址是 `08:00:2B:00:EE:0A`。
        
3. **ARP 高速缓存**：
    
    - 主机 A 和主机 B 各自会将对方的 IP 地址和 MAC 地址映射保存到自己的 ARP 高速缓存中。
        


### 为什么不直接使用硬件地址进行通信？

1. **不同网络使用不同的硬件地址体系**：
    
    - **硬件地址**（例如 **MAC 地址**）是与 **数据链路层**（如 Ethernet）相关的地址，它们是 **物理地址**，主要用于局域网内的通信。
        
    - **IP 地址** 是 **网络层** 的地址，它是设计用来实现跨网络、不同类型的网络之间的通信的。
        
     - **全球范围内存在各种不同的网络**，每种网络可能使用不同的硬件地址体系。例如，Ethernet 使用 MAC 地址，Wi-Fi 使用 IEEE 802.11 地址，其他专用网络可能使用不同的硬件地址体系。直接使用硬件地址会造成网络间的兼容性问题和硬件地址转换的复杂性。
    
2. **跨网络通信的复杂性**：
    
    - 如果我们只使用硬件地址进行通信，那么在每个网络之间都需要对硬件地址进行映射和转换，这将是非常复杂且效率低下的。每个网络都需要维护庞大的硬件地址表，进行地址转换的操作，不仅导致管理成本的增加，也使得网络通信的效率变得非常低。
        
3. **路由和跨网络通信的便利性**：
    
    - **IP 地址** 提供了一个 **统一的地址体系**，使得不同的网络可以通过 **路由器** 来实现互联。每个网络只需要关注本地的硬件地址，通过 **IP 地址** 来实现不同网络之间的通信。
        
    - 路由器使用 **IP 地址** 来进行跨网络路由，路由表只需要存储网络层的 **IP 路由信息**，而不需要管理复杂的硬件地址信息。
        
    - 当数据报需要发送到下一个网络时，**ARP** 协议会在需要时自动将目标 IP 地址映射到硬件地址，减少了复杂性和网络管理的难度。
        

### 为什么不直接使用 IP 地址来传输数据？

- **硬件层的效率问题**：
    
    - 如果我们只使用 **IP 地址**，每个站点在接收到数据帧后需要解开整个 **IP 数据报** 来查看目标地址，并判断是否需要处理这个数据报。这对于每个设备来说是一个计算开销，尤其是在大型网络中会产生巨大的性能负担。
        
    - 使用 **MAC 地址** 可以在 **数据链路层**（即 **局域网**）通过硬件进行快速的地址匹配，**硬件可以直接判断** 是否需要处理该数据帧，而无需进行更复杂的操作。
        
    - **MAC 地址** 使得设备在接收到帧时可以通过硬件直接判定是否属于目标地址。这样，设备可以在硬件层面完成数据帧的过滤，从而提高网络效率，避免了不必要的处理开销。
        


- **IP 地址** 用于 **网络层**，它使得不同的网络能够互联，支持跨网络的路由。它提供了 **全球统一的地址体系**，避免了不同网络之间直接使用硬件地址的复杂性。
    
- **MAC 地址** 用于 **数据链路层**，它是 **硬件地址**，通常用于 **局域网内部通信**，并通过硬件快速判断是否处理该数据帧，节省了处理成本。

### IP 数据报的格式

一个 **IP 数据报** 由两部分组成：**首部** 和 **数据部分**。

#### 1. **IP 数据报的固定首部**

- **长度**：IP 数据报的固定首部的长度是 **20 字节**。
    
- 这部分是所有 IP 数据报都必须具有的，不会变化。
    
- **包含的信息**：该固定部分主要包括一些基础信息，如：
    
    - **版本号**（Version）：表明该数据报是 IPv4 还是 IPv6。
        
    - **头部长度**（Header Length）：即固定部分之后的可选字段长度。
        
    - **类型服务（Type of Service）**：用于指定数据包的优先级和服务质量。
        
    - **总长度**（Total Length）：整个 IP 数据报的长度（包括首部和数据部分）。
        
    - **标识符**（Identification）：标识分片的数据报，避免混淆。
        
    - **标志**（Flags）：用于控制和标识数据报分片的处理方式。
        
    - **片偏移**（Fragment Offset）：指示数据报分片的位置信息。
        
    - **生存时间**（Time to Live, TTL）：表示数据报在网络中可以存在的最大时间（或跳数），防止数据包在网络中永远循环。
        
    - **协议**（Protocol）：表示数据报携带的是哪种上层协议（如 TCP、UDP）。
        
    - **头部校验和**（Header Checksum）：用于检验首部是否有错误。
        
    - **源 IP 地址**（Source IP Address）：发送方的 IP 地址。
        
    - **目的 IP 地址**（Destination IP Address）：接收方的 IP 地址。
        

#### 2. **可选部分（可变长度）**

- **可选字段**：在固定部分后，可能会有一些 **可选字段**，这些字段是可变长度的。根据需要，可以包含一些附加信息。
    
- **长度**：可选字段的长度是可变的，因此整个首部的总长度可能会超过 20 字节，最多可以扩展到 60 字节（20 字节固定部分 + 40 字节可选部分）。
    

#### 3. **IP 数据报的总体结构**

```
+-------------------------------+
| 固定首部 (20字节)               |
+-------------------------------+
| 可选字段 (可变长度)            |
+-------------------------------+
| 数据部分                       |
+-------------------------------+
```

**数据部分**包括要传输的实际数据（如来自应用层的数据）。

---
# IP数据报分片

- 在首部的标志位里，最低位是**MF**， **MF=1**表示后续还有分片，**MF=0**表示这是最后一个分片。
- 中间一位是**DF (Don‘t Fragment)**，值是0才允许分片。
- 片位移以8字节为一个单位。
#### 例题

> 一个数据报总长度为3820字节，使用固定首部，需要分片的长度不能超过1420字节，数据部分共3800字节，请问如何实现分片？

- 总长度：3820字节
- 数据部分：3800字节
- 首部长度：3820 - 3800 = 20字节（固定首部）
- 每个分片最大长度：1420字节

##### 数据报片1
- 首部：20字节
- 数据：1400字节（1420 - 20 = 1400）
- 偏移量：0 / 8 = 0（偏移量以8字节为单位）
- MF=1（More Fragment，表示后面还有分片）
- DF=0（Don't Fragment，允许分片）

##### 数据报片2
- 首部：20字节
- 数据：1400字节
- 偏移量：1400 / 8 = 175（第一个分片数据长度/8）
- MF=1
- DF=0

##### 数据报片3
- 首部：20字节
- 数据：3800 - 1400 - 1400 = 1000字节（剩余数据）
- 偏移量：2800 / 8 = 350（前两个分片数据长度总和/8）
- MF=0
- DF=0

##### 分片表格

| 分片编号 | 首部长度 | 数据长度 | 总长度  | 偏移量(字节) | 偏移量(8字节单位) | MF  | DF  |
| ---- | ---- | ---- | ---- | ------- | ---------- | --- | --- |
| 1    | 20   | 1400 | 1420 | 0       | 0          | 1   | 0   |
| 2    | 20   | 1400 | 1420 | 1400    | 175        | 1   | 0   |
| 3    | 20   | 1000 | 1020 | 2800    | 350        | 0   | 0   |

# 子网划分与子网掩码

- **子网划分**：IP 地址可以被划分成多个子网，通过这种方式可以将一个大的网络分割成多个较小的网络（子网），从而提高网络的效率并更好地管理网络资源。
    
- **子网掩码（Subnet Mask）**：子网掩码是一个用于指示 IP 地址中哪些部分表示网络部分，哪些部分表示主机部分的 32 位二进制数。
    
    - **网络部分**：由子网掩码中为 1 的位表示。
        
    - **主机部分**：由子网掩码中为 0 的位表示。
        
- **路由器：
    - 在与相邻路由器交换路由信息时，路由器必须将自己所在网络（或子网）的 **子网掩码** 告诉相邻路由器。
        
    - 路由器的路由表中的每一项不仅要提供 **目的网络地址**，还必须同时给出该网络的 **子网掩码**。
        
- **多网段路由器**：
    
    - 若一个路由器连接到两个子网上，它就会拥有 **两个网络地址** 和 **两个子网掩码**。
**子网掩码的作用**：

- 它帮助确定某个 IP 地址所属的网络范围。例如，对于一个 IP 地址和子网掩码，可以通过按位与运算（AND）来计算出网络地址。网络地址用于识别该主机所在的子网。
- 它帮助识别网络地址和主机地址，决定 IP 地址中的哪些部分属于网络，哪些部分属于主机。

#### /24子网掩码的二进制表示

/24表示子网掩码中有24个连续的1位，后面跟着8个连续的0位。

子网掩码/24的二进制表示为：
```
11111111.11111111.11111111.00000000
```

转换为十进制点分格式是：
```
255.255.255.0
```

这表示:
- 前24位(前三个字节)是网络位，全部为1
- 后8位(最后一个字节)是主机位，全部为0

允许在一个子网中有254个可用主机地址(2^8-2)。
#### **示例**：

假设有以下 IP 地址和子网掩码：

- **IP 地址**：`192.168.1.100`
    
- **子网掩码**：`255.255.255.0`
    
- **子网掩码转换为二进制**：`11111111.11111111.11111111.00000000`
    
    - 这里前 24 位（`11111111.11111111.11111111`）表示网络部分，剩余 8 位表示主机部分。
        
- 通过子网掩码与 IP 地址进行按位与运算：
    
    - **IP 地址**：`11000000.10101000.00000001.01100100`
        
    - **子网掩码**：`11111111.11111111.11111111.00000000`
        
    
    结果是：`11000000.10101000.00000001.00000000`，即 `192.168.1.0`，这是该 IP 地址所属的网络地址。
    

| 类别  | IP 地址范围                       | 默认子网掩码          |
| --- | ----------------------------- | --------------- |
| A 类 | `0.0.0.0 - 127.255.255.255`   | `255.0.0.0`     |
| B 类 | `128.0.0.0 - 191.255.255.255` | `255.255.0.0`   |
| C 类 | `192.0.0.0 - 223.255.255.255` | `255.255.255.0` |
**不同的子网掩码得出相同的网络地址。但不同的掩码的效果是不同的。**


#### 例题：基于子网掩码判断同一网段的IP地址

要判断哪些IP地址与192.168.16.35在同一子网内，子网掩码255.255.255.240。
##### 1. 分析子网掩码
子网掩码255.255.255.240的二进制表示：
```
11111111.11111111.11111111.11110000
```

这表示前28位是网络位，后4位是主机位(即/28)。
要确定一个子网掩码中有多少个网络位，最直观的方法是将子网掩码转换为二进制，然后数连续的"1"的个数：
1. 将子网掩码转换为二进制
2. 从左到右计算连续的"1"的数量，直到出现"0"
3. "1"的数量就是网络位的数量
##### 2. 计算网络地址
将目标IP地址与子网掩码进行按位与运算：

192.168.16.35 的二进制：
```
11000000.10101000.00010000.00100011
```

与子网掩码按位与：
```
11000000.10101000.00010000.00100011 (192.168.16.35)
11111111.11111111.11111111.11110000 (255.255.255.240)
-----------------------------------
11000000.10101000.00010000.00100000 (192.168.16.32)
```

所以网络地址是192.168.16.32。

##### 3. 确定地址范围
有了网络地址和子网掩码，可以计算该子网的地址范围：

- **可用主机地址数**: 2^4 - 2 = 14个地址 (2^主机位数 - 2)
- **网络地址**: 192.168.16.32
- **广播地址**: 192.168.16.47 (网络地址 + 可用地址数 + 1)
- **可用IP范围**: 192.168.16.33 - 192.168.16.46

##### 4. 判断结果
**与192.168.16.35在同一子网内的地址包括**:
- 192.168.16.33 至 192.168.16.46 (包含192.168.16.35本身)


# CIDR

- **CIDR**（Classless Inter-Domain Routing）消除了传统的 A 类、B 类和 C 类地址，以及划分网段的概念，从而更加高效地分配 IPv4 地址空间。
    
- **CIDR 使用网络前缀**（network prefix）来代替分类地址中的网络号和子网号，提供了更灵活的 IP 地址分配方式。
    
- **三级编址与二级编址**：
    
    - 在传统的分类地址中，IP 地址是基于 A 类、B 类和 C 类地址进行划分的（三级编址）。
        
    - **CIDR** 则采用了**两级编址**的方式，简化了地址的管理，IP 地址记法为：`<网络前缀>, <主机号>`。
        
- **斜线记法**（Slash Notation）：
    
    - CIDR 使用**斜线记法**（也称为 CIDR 记法），例如：`12.14.46.34/20`。
        
    - **/20** 表示网络前缀的比特数，这里网络前缀为 20 位。
        
- **CIDR 地址块**：
    
    - CIDR 将网络前缀相同的连续 IP 地址组成 **CIDR 地址块**，例如：`12.14.35.7/20`。
        
    - **/20** 表示该地址块的网络前缀占 20 位，剩余的 12 位为主机号。
        
    - 对于 `12.14.35.7/20` 地址块，计算出：
        
        - 最小地址：`12.14.32.0`
            
        - 最大地址：`12.14.47.255`
            
- **全 0 和全 1 的主机号地址通常不使用**，例如网络地址和广播地址。
    
- **CIDR 地址块表示多个地址**，这种地址聚合称为 **路由聚合**（Route Aggregation），也叫 **超网**。
    
- **掩码**：CIDR 仍然使用“掩码”这一概念，但不再称之为子网掩码。
    
    - 对于 `/20` 地址块，掩码是 20 个连续的 1，例如：`255.255.240.0`。
        
    - 斜线记法中的数字表示掩码中 1 的个数。
        
- **简写表示法**：
    
    - 如 `10.0.0.0/10` 可以简写为 `10/10`，即省略了点分十进制中的低位连续的 0。
        
- **CIDR 地址块的隐含掩码**：
    
    - 例如 `10.0.0.0/10` 隐含地表示掩码是 `255.192.0.0`，即掩码为 10 个连续的 1。
        
- **网络前缀加星号（*）表示法**：
    
    - 例如：`0.0.0.0*` 表示所有 IP 地址。
        

#### 例题：路由汇聚

假设下面有 4 个路由，如果这四个进行路由汇聚，能覆盖这四个路由的是？
- `172.18.129.0/24`
- `172.18.130.0/24`
- `172.18.132.0/24`
- `172.18.133.0/24`
##### 步骤 1：查看这些地址的二进制表示

我们将它们的前 24 位（即子网掩码为 `/24`）进行比较。
1. `172.18.129.0` 的二进制：
    `10101100.00010010.10000001.00000000`
2. `172.18.130.0` 的二进制：
    `10101100.00010010.10000010.00000000`
3. `172.18.132.0` 的二进制：
    `10101100.00010010.10000100.00000000`
4. `172.18.133.0` 的二进制：
    `10101100.00010010.10000101.00000000`
##### 步骤 2：找到公共前缀

从上面的二进制表示，我们可以看到它们的前 22 位是相同的：
`10101100.00010010.1000`
这部分是相同的，因此，我们可以使用 `/22` 作为新的子网掩码来汇聚这四个路由。
##### 步骤 3：计算路由汇聚后的网络

我们选择使用 `/22` 网络掩码来汇聚，得到的网络地址将是：
- `172.18.128.0/22`

# CIDR

#### **1. CIDR 地址块与路由聚合**

CIDR（Classless Inter-Domain Routing）技术被用于简化路由表和提高地址空间利用效率。通过 CIDR，多个连续的 IP 地址可以通过 **路由聚合**（Route Aggregation）合并成一个更大的网络地址块，从而减少路由表中的条目数，优化路由效率。
#### **2. 举例：ISP 地址块划分**

假设一个 ISP（Internet Service Provider）拥有以下地址块：
- `206.0.64.0/18`
- `206.0.68.0/22`
- `206.0.68.0/22`
- `206.0.68.128/25`
- `206.0.69.0/25`
- `206.0.70.0/26`
- `206.0.70.64/26`
- `206.0.70.128/26`
- `206.0.70.192/26`
- `206.0.71.0/25`
- `206.0.71.64/26`
- `206.0.71.128/26`
这些地址块表示了 ISP 分配的多个子网。原本，ISP 有 64 个 C 类网络。如果不使用 CIDR，每个子网都需要在路由表中记录，并且每个路由器的路由表中会有 64 项记录。这会导致路由表非常庞大且不易管理。

#### **3. CIDR 聚合的作用**

通过使用 CIDR，ISP 可以将这些连续的 IP 地址块聚合成一个更大的地址块，从而减少路由表中的条目数。以下是实现地址聚合的过程：

1. **原始地址块**：
    
    - `206.0.64.0/18`（包含 `206.0.64.0` 到 `206.0.127.255`）
        
    - `206.0.68.0/22`（包含 `206.0.68.0` 到 `206.0.71.255`）
        
    - `206.0.70.0/26`（包含 `206.0.70.0` 到 `206.0.70.63`）
        
    - `206.0.70.64/26`（包含 `206.0.70.64` 到 `206.0.70.127`）
        
2. **CIDR 聚合后**：
    
    - 如果进行 CIDR 地址块聚合，ISP 可以将多个连续的地址块聚合成一个大的块，如：`206.0.64.0/18` 作为一个统一的路由条目来代替多个子网的路由条目。
    
    - 通过这种方法，只需要一个路由条目 `206.0.64.0/18`，而不再需要记录 64 个独立的 C 类网络地址块，从而显著减少了路由器路由表的条目数量。

但采用 CIDR 技术后，通过 **地址聚合**，所有这些子网可以通过一个地址块 `206.0.64.0/18` 来表示，其他路由器只需要处理这一条路由，显著减少了路由表的大小，并提高了路由效率。

### **最长前缀匹配

#### **1. 简介
在 **CIDR（无类域间路由）** 中，**最长前缀匹配** 是一种用来选择路由表条目的方法。简单来说，它是指当一个数据包到达路由器时，路由器会检查路由表中与数据包目标地址最匹配的条目。匹配的方式是选择 **网络前缀越长** 的条目。

- **网络前缀越长**，表示地址块越小，路由越具体。
    
- **最长前缀匹配** 也叫做 **最佳匹配**，因为它会选择与目标地址最为精确的匹配项。
    

#### **2. 如何进行最长前缀匹配？**

最长前缀匹配的过程如下：

1. **接收数据包**：当路由器收到一个数据包时，会查看数据包的目标 IP 地址。
    
2. **检查路由表**：路由器将目标 IP 地址与路由表中的所有网络前缀进行匹配。
    
3. **选择最长匹配**：选择与目标地址匹配且网络前缀最长的路由条目。网络前缀越长，表示路由条目越具体。
    
4. **转发数据包**：根据选择的匹配条目，将数据包转发到对应的下一跳地址。
#### **3. 计算过程**

假设收到一个目标地址为 `206.0.71.130` 的数据包，路由表中的两个条目如下：

- 路由表项 1: `206.0.68.0/22`
    
- 路由表项 2: `206.0.71.128/25`
    

我们需要根据目标地址 `206.0.71.130` 查找匹配的路由，步骤如下：

##### 步骤一：将目标地址和路由表项转为二进制

**目标地址**: `206.0.71.130`
```
11001110.00000000.01000111.10000010
```

**路由表项 1**: `206.0.68.0/22`
```
11001110.00000000.01000100.00000000
```
前缀长度22位，即前22位必须匹配

**路由表项 2**: `206.0.71.128/25`
```
11001110.00000000.01000111.10000000
```
前缀长度25位，即前25位必须匹配

##### 步骤二：比较目标地址与路由表项的前缀匹配情况

**与路由表项1比较前22位**:
```
目标地址: 11001110.00000000.01000111.10000010
路由项1:  11001110.00000000.010001xx.xxxxxxxx (前22位固定)
```


**与路由表项2比较前25位**:
```
目标地址: 11001110.00000000.01000111.10000010
路由项2:  11001110.00000000.01000111.10000000 (前25位固定)
```
比较前25位，所有位都匹配，因此目标地址与路由表项2匹配。
##### 步骤三：选择最长前缀匹配的路由表项

- 路由表项1：前缀长度22位，匹配
- 路由表项2：前缀长度25位，匹配

根据最长前缀匹配原则，路由器会选择前缀长度更长的路由表项2（25位前缀长度）来转发数据包，因为它提供了更精确的路由信息。

#### 例题

> 某公司拥有一个/22的地址块，以VLSM（Variable Length Subnet Mask，变长子网掩码）来划分子网。其中部门A拥有主机数5个，部门B拥有主机数250个，部门C拥有主机数120个，部门D拥有主机数60个，部门E拥有主机数25个，部门F拥有主机数12个。  
##### 1.如果为这6个部门划分6个子网，请写出它们的子网掩码（尽量不要浪费IP地址）。

##### 2. 还有多少个IP地址未分配子网？

##### 3. 为什么非空子网的子网掩码不可以是255.255.255.254？

##### (1) 为6个部门划分子网（尽量不浪费IP地址）

首先计算各部门需要的实际IP地址数量（包括网络地址和广播地址）：
- 部门A：500个主机 → 需要500+2=502个地址 → 需要至少9位主机位(2^9=512)
- 部门B：250个主机 → 需要250+2=252个地址 → 需要至少8位主机位(2^8=256)
- 部门C：120个主机 → 需要120+2=122个地址 → 需要至少7位主机位(2^7=128)
- 部门D：60个主机 → 需要60+2=62个地址 → 需要至少6位主机位(2^6=64)
- 部门E：25个主机 → 需要25+2=27个地址 → 需要至少5位主机位(2^5=32)
- 部门F：12个主机 → 需要12+2=14个地址 → 需要至少4位主机位(2^4=16)

公司拥有/22的地址块，意味着有10位主机位，总共可用地址数为2^10=1024个地址。**("/n"表示前n位是网络位，剩余(32-n)位是主机位)**。

按照VLSM原则，从需要最多地址的部门开始分配：

1. **部门A**：需要9位主机位
   - 子网掩码：255.255.254.0 (/23)
   - 可用主机数：510个

2. **部门B**：需要8位主机位
   - 子网掩码：255.255.255.0 (/24)
   - 可用主机数：254个

3. **部门C**：需要7位主机位
   - 子网掩码：255.255.255.128 (/25)
   - 可用主机数：126个

4. **部门D**：需要6位主机位
   - 子网掩码：255.255.255.192 (/26)
   - 可用主机数：62个

5. **部门E**：需要5位主机位
   - 子网掩码：255.255.255.224 (/27)
   - 可用主机数：30个

6. **部门F**：需要4位主机位
   - 子网掩码：255.255.255.240 (/28)
   - 可用主机数：14个

##### (2) 未分配的IP地址数量计算

已分配的地址数量：
- 部门A：512个地址
- 部门B：256个地址
- 部门C：128个地址
- 部门D：64个地址
- 部门E：32个地址
- 部门F：16个地址

总计已分配：512+256+128+64+32+16 = 1008个地址

公司拥有的总地址数：1024个地址

未分配的地址数：1024-1008 = 16个地址

##### (3) 为什么非空子网的子网掩码不可以是255.255.255.254

子网掩码255.255.255.254的二进制表示是：
```
11111111.11111111.11111111.11111110
```

这表示只有1位主机位，即只能表示2^1=2个地址。

在IP地址分配中，每个子网至少需要2个特殊地址：
- 网络地址（主机位全为0）：用于标识网络本身
- 广播地址（主机位全为1）：用于向网络内所有主机发送数据

当子网掩码为255.255.255.254时，这2个地址都被用作特殊用途，没有剩余地址可以分配给实际主机使用。因此，非空子网（需要至少一个可用主机地址）的子网掩码不能是255.255.255.254。

实际上，最小的可用于实际主机分配的子网掩码是255.255.255.252 (/30)，它提供2个可用主机地址，通常用于点对点连接。


# ICMP网际控制报文协议

- **ICMP概述**：
    
    - ICMP 是一个网络层协议，用于报告差错和异常情况。它不是高层协议，而是IP层的协议。
        
    - ICMP 报文作为 IP 数据报的数据，通过 IP 数据报发送。
        
- **ICMP报文种类**：
    
    - ICMP 报文分为两类：
        
        - **差错报告报文**：用于报告网络问题或差错。
            
        - **询问报文**：用于网络诊断和状态查询。
            
- **ICMP报文结构**：
    
    - ICMP 报文的前 4 个字节是固定格式，包含三个字段：
        
        1. **类型（Type）**：用于区分不同的 ICMP 报文类型。
            
        2. **代码（Code）**：进一步区分同一类型下的不同情况。
            
        3. **检验和（Checksum）**：用于检验 ICMP 报文的完整性。
            
    - 之后的 4 个字节的内容与 ICMP 的类型相关。
        

---

#### 1. **ICMP 差错报告报文**（Error Reporting Messages）：

- **目的**：用于报告IP数据报的错误或异常情况。
    
- **差错报告报文的类型有**：
    
    1. **目的站不可达**：报告目标主机无法到达。
        
    2. **源站抑制**：当网络出现拥塞时，源主机会收到提示，要求减少数据发送速率。
        
    3. **时间超过**：表示数据报在传输过程中超时，未能及时到达目标。
        
    4. **参数问题**：表示数据报的首部存在错误，无法被处理。
        
    5. **改变路由（重定向）**：建议源主机改变其路由，选择更合适的路由路径。
        
- **注意**：以下情况不会发送 ICMP 差错报告报文：
    
    1. 对于 ICMP 差错报告报文本身，不再发送新的 ICMP 差错报告。
        
    2. 对于第一个分片的数据报的后续分片。
        
    3. 对于具有多播地址的数据报。
        
    4. 对于特殊地址（如 `127.0.0.0` 或 `0.0.0.0`）的数据报。
        

---

#### 2. **ICMP 询问报文**（Inquiry Messages）：

- **目的**：用于网络的诊断、查询等操作。
    
- **常见的 ICMP 询问报文**：
    
    1. **回送请求和回送回答报文**：例如 `PING`（Packet Internet Groper），用于测试两台主机之间的连通性。
        
    2. **时间戳请求和时间戳回答报文**：用于测量数据报传输时间。
        
- **已经不再使用的 ICMP 询问报文**：
    
    1. **掩码地址请求和回答报文**。
        
    2. **路由器询问和路由器通告报文**。
        

---

#### 3. **PING（Packet Internet Groper）**：

- **功能**：PING 是用于测试两个主机之间是否能够成功通信的工具。
    
    - 它利用 ICMP 的回送请求和回送回答报文。
        
    - 通过发送 ICMP 回送请求并等待回送回答，判断主机之间的连通性。
        
- **应用层与网络层**：PING 直接使用 ICMP 协议，未经过运输层（如 TCP 或 UDP）。
    

---

- **ICMP 协议**是 IP 层协议，用于报告错误和提供网络状态信息。
    
- 它有差错报告报文（如目的不可达、源站抑制、时间超过等）和查询报文（如 PING 等）。
    
- ICMP 对于网络的管理和故障排除非常重要，它通过回送请求和回送回答等方式来验证网络连通性。

# 常见的TCP/IP协议

### 1. **ARP（Address Resolution Protocol，地址解析协议）**

- **作用**：ARP 用于在本地网络中根据 IP 地址获取对应的 **MAC 地址**，即将网络层的 IP 地址转换为数据链路层的硬件地址。
    
- **ARP 只负责地址解析。
### 2. **IGMP（Internet Group Management Protocol，互联网组管理协议）**

- **作用**：IGMP 是一种用于主机与路由器之间管理 IP 多播组的协议。它允许主机加入或离开多播组。通常用于视频流、在线游戏等需要组播的应用。
    
- IGMP 的主要功能是管理多播组成员。IGMP（互联网组管理协议）并不负责在因特网范围内管理所有多播组的成员，也无法得知各个多播组的成员数量或成员分布在哪些网络上。IGMP 协议的作用是让本地局域网内的多播路由器了解到，是否有主机（严格来说，是主机上的某个进程）加入或退出某个多播组。
### 3. **ICMP（Internet Control Message Protocol，网际控制报文协议）**

- **作用**：ICMP 是一个网络层协议，用于报告网络中出现的各种错误和异常信息。它能够报告如 **网络不可达**、**主机不可达**、**路由重定向**、**时间超时** 等错误信息。
    
### 4. **TCP（Transmission Control Protocol，传输控制协议）**
- **作用**：TCP 是一个可靠的、面向连接的传输层协议，用于确保数据在传输过程中不丢失、顺序正确并且完整。它使用序列号、确认号、校验和等机制来提供可靠的数据传输。
    
### 5.**DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）**

- **DHCP** 是一种网络协议，用于自动为网络中的设备分配 IP 地址及其他网络配置信息（如子网掩码、默认网关和 DNS 服务器等），使得设备在接入网络时能够自动获取所需的网络参数，而不需要手动配置每个设备的 IP 地址。

DHCP 的工作方式遵循客户端-服务器模型，其中包括 **DHCP 客户端** 和 **DHCP 服务器**。主要过程如下：

1. **发现（DHCP Discover）**：当一个新的设备（DHCP 客户端）连接到网络时，它会广播一个 DHCP Discover 消息，向网络上的 DHCP 服务器请求配置参数。这个消息中没有任何 IP 地址信息，因为设备还没有得到配置。
    
2. **提供（DHCP Offer）**：所有收到 DHCP Discover 消息的 DHCP 服务器会响应一个 DHCP Offer 消息，包含一个可供设备使用的 IP 地址、子网掩码、默认网关、DNS 服务器等信息。
    
3. **请求（DHCP Request）**：设备接收到一个或多个 DHCP Offer 后，会选择一个 DHCP 服务器并向其发送 DHCP Request 消息，表明接受该服务器提供的配置。
    
4. **确认（DHCP Acknowledgement）**：DHCP 服务器收到 DHCP Request 后，确认并分配所请求的 IP 地址等配置信息，向客户端发送 DHCP Acknowledgement（DHCP ACK）消息。
    
5. **租约（Lease）**：DHCP 客户端获取 IP 地址后，该 IP 地址的分配是临时的，称为“租约”。租约期结束后，客户端必须向 DHCP 服务器申请续租或者重新申请新的 IP 地址。

#### **DHCP 的优点**

- **简化配置**：无需手动配置每个设备的 IP 地址，减少了管理工作和配置错误的机会。
    
- **动态分配**：设备可以在每次连接网络时自动获取新的 IP 地址，不需要静态分配。
    
- **节省地址空间**：通过租约机制，IP 地址可以重复利用，使得有限的地址空间得到更有效的利用。
    
#### **DHCP 的组成部分**

1. **DHCP 服务器**：提供并管理 IP 地址池，分配 IP 地址及其他网络配置。
    
2. **DHCP 客户端**：请求并接收 IP 地址及其他配置信息的设备。
    
3. **IP 地址池**：DHCP 服务器维护的一个 IP 地址范围，用于动态分配给客户端设备。
    
4. **租约时间**：为每个分配的 IP 地址设置的有效期。租约期满后，设备需要向 DHCP 服务器续租或重新分配 IP 地址。
    

# IP多播

IP 多播（Multicast）是一种通信方式，允许数据包从一个源主机发送到多个目标主机，同时减少了带宽的浪费。
#### **1. 多播使用组地址（D 类地址）**

- **D 类地址**：IP 多播使用 **D 类地址** 来标识多播组。D 类地址的范围是 **224.0.0.0 到 239.255.255.255**，它被专门用于多播通信。
    
- 多播地址只能作为 **目的地址**，不能作为 **源地址**。这意味着在多播通信中，源主机发送的数据包需要指定一个**多播组的地址**作为目的地址。
    

#### **2. 永久组地址**

- **组地址管理**：永久组地址由 **IANA（互联网号码分配局）** 负责管理和分配。永久组地址是多播组的标识符，一般用于长期存在的组，代表特定的多播通信目标。
    

#### **3. 需要多播路由器**

- **多播路由器**：为了实现多播通信，网络中必须部署 **多播路由器**，这些路由器负责在不同的网络段之间转发多播流量。多播路由协议（如 **PIM**）用于确定数据如何从源主机传输到多个接收主机。
    

#### **4. 使用硬件支持多播**

- **硬件支持**：在多播通信中，硬件（如以太网适配器）必须能够识别多播地址并转发数据包。例如，以太网设备必须支持将多播地址映射到正确的物理地址，以确保数据包能够准确地发送到多播主机组中的所有成员。
    

#### **5. D 类 IP 地址与以太网地址的关系**

- **IP 多播与以太网地址映射**：在以太网中，D 类地址的 **低 23 位** 会被复制到以太网地址的 **目的地址** 中。在多播主机组标识符中的 5 bit 不能用来构成以太网地址。例如，当多播数据包通过以太网传输时，多播组的地址需要被映射成相应的 **以太网 MAC 地址**。这种映射关系允许以太网设备识别并正确转发多播数据包。
    

#### **6. 多播的标识符**

- **多播主机组标识符**：D 类地址中的 **最低位比特**（通常是目的地址的第 1 字节中的最低位）被设置为 **1**，以表明该地址是多播地址。这种设置有助于网络设备区分普通单播地址和多播地址。
    
