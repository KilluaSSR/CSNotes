# 基础

## 定义

- 嵌入式系统是用于控制、监视或者辅助操作机器和设备的装置。是以应用为中心、以计算机技术为基础、软件硬件可裁剪、功能、可靠性、成本、体积、功耗严格要求的专用计算机系统。
- 它是以**微处理器为核心**的专用智能系统。

## 嵌入式编程基础

### 与普通C语言的差别

> 以下是一段常见的普通C代码，打印输出“Hello World”：

``` C
#include <stdio.h>
int main(){
	printf("Hello World");
	return 0;
}
```

- 可以看出，程序运行到`return 0` 处即退出，此时`main`函数执行完毕。

> 以下是一段常见的嵌入式C代码：

```C
int main(){
	while(1){
	function1();
	function2();
	}
}
```

- **嵌入式系统的软件是没有出口的**，程序不能“退出”，整个程序的结构应该是无限的循环。
- 嵌入式系统的软件设计需要考虑硬件的支持、操作系统的支持、程序的初始化和引导等诸多的方面。

### 大小端模式

#### 大端模式

规则是：**最高有效字节 (Most Significant Byte, MSB) 存储在最低的内存地址上**，而最低有效字节 (Least Significant Byte, LSB) 存储在最高的内存地址上。

##### 以`12345678`为例：

| 低地址 |     |
| --- | --- |
| A   | 12  |
| A+1 | 34  |
| A+2 | 56  |
| A+3 | 78  |
| 高地址 |     |
#### 小端模式

规则是：**最低有效字节存储在最低的内存地址** (p)，然后字节依次向高地址存放。

##### 还是以`12345678`为例：

| 低地址 |     |
| --- | --- |
| A   | 78  |
| A+1 | 56  |
| A+2 | 34  |
| A+3 | 12  |
| 高地址 |     |
#### 注意

- 大小端的字节存放顺序相反

因此，如果有一个4字节的`int` 变量值为`0x12345678`，内存里的地址是`p`，则在大端和小端编译环境里，以下地址内字节值分别是：

|     | p    | p+1  | p+2  | p+3  |
| --- | ---- | ---- | ---- | ---- |
| 大端  | 0x12 | 0x34 | 0x56 | 0x78 |
| 小端  | **0x78** | **0x56** | **0x34** | **0x12** |
### 字节对齐问题

- 字节对齐是指编译器在内存中放置数据时，要求数据的起始地址是其类型大小（或特定对齐值）的倍数。
- 这么做可以提高内存访问效率，满足某些硬件架构的存取限制。CPU 通常以字（word）为单位读写，对齐的数据可以一次读写完成。
- 编译器会在变量之间或结构体末尾插入填充字节 (Padding) 来满足对齐要求。

#### 举例

```c
struct Example {
    char c1; // 1 byte
    int i;   // 4 bytes
    char c2; // 1 byte
}Ex;
```

- `c1` (1 byte, align 1): 存放在地址 0。下一地址为 1。
- `i` (4 bytes, align 4): 需要从地址是 4 的倍数开始。当前地址 1 不满足。编译器插入 3 字节填充。`i` 存放在地址 4。下一地址为 8。
- `c2` (1 byte, align 1): 当前地址 8 满足。存放在地址 8。下一地址为 9。
- **结构体总大小:** 结构体自身对齐值是其成员中最大对齐值 (这里是 `int` 的 4)。总大小 (目前 9 字节) 必须是 4 的倍数。需要填充 `12 - 9 = 3` 字节到末尾。

**最终布局:**

`sizeof(struct Example)` 为 12 字节，而非成员大小之和 (1+4+1=6)。

| 内存地址偏移范围 | 内容           | 大小 (字节) |
| :------- | :----------- | :------ |
| 0        | `c1`         | 1       |
| 1-3      | 填充 (Padding) | 3       |
| 4-7      | `i`          | 4       |
| 8        | `c2`         | 1       |
| 9-11     | 填充 (Padding) | 3       |
| **总大小**  |              | **12**  |
## 嵌入式系统与单片机

### 硬件比较

| 名称          | 嵌入式系统         | 单片机        |
| ----------- | ------------- | ---------- |
| 硬件平台        | 厂家提供通用的硬件平台   | 自己设计制作硬件平台 |
| 硬件设计        | 以硬件平台为基础裁剪和扩展 | 重新设计       |
| CPU         | 一般为32位        | 多为8位或16位   |
| MMU(存储管理单元) | 支持            | 不支持        |
| 功能          | 能够实现复杂功能      | 难于实现复杂功能   |
| 开发人员        | 主要为计算机专业人员    | 硬件设计人员     |
| 仿真器         | 通常初始化使用，以后不使用 | 全程使用       |
| 仿真头         | 不需要           | 需要         |
### 软件比较

| 名称   | 嵌入式系统                           | 单片机         |
| ---- | ------------------------------- | ----------- |
| 开发平台 | 主机上相匹配的操作系统                     | 主机上的仿真软件    |
| 功能   | 相对复杂                            | 通常比较简单      |
| 运行环境 | 嵌入式操作系统                         | 直接运行在硬件上    |
| 编程语言 | C、Java及框架                       | C、汇编        |
| 协议支持 | 嵌入式操作系统提供，如USB协议和网络协议，**移植后**使用 | 自己实现        |
| 驱动程序 | 操作系统提供大部分驱动                     | 自己实现        |
| 调试   | 交叉编译，操作系统环境调试                   | 专门的仿真软件在线调试 |

## 嵌入式处理器

### 几种传统处理器

1. 微控制单元(MCU)：集成CPU、RAM、ROM、定时器和多种I/O接口
    
    如51、PIC和AVR系列单片机
    
2. 数字信号处理器(DSP)：专注于信号处理，如音视频编解码
    
    一般频率较高，代表厂商为`TI`
    
3. 微处理器(MPU)：专注于运算性能和速度，没有集成外设
    
    Intel的X86处理器是MPU的代表

#### 基于IP核的片上系统（SoC）

随着技术进步，常常将许多独立 IC 组成的电子系统集成在一个单片硅片上，构成系统芯片。这些系统芯片常常包含：

1. 处理器核心
    1. ARM RISC
    2. MIPS RISC
    3. DSP核心
2. 各种通信模块
    1. TCP/IP通信单元
    2. GPRS通信单元
    3. GSM通信单元
3. 其他模块
    1. USB单元
    2. IEEE1394
    3. 蓝牙模块

#### IP Core（Intellectual Property Core，知识产权核）

- 每种系统芯片都是由硬件描述语言设计，然后在芯片内由电路实现的
- 这些系统芯片构成功能模块，被设计厂家以知识产权的形式提供给用户
- 这些模块称为称为IP Core，Intellectual Property Core
#### 分类
1. **软核**：以**硬件描述语言编写的程序形式**提供给用户
2. **硬核**：以**硬件原理图与板图的形式**提供给用户

#### SoC（System on Chip）

- **SoC 是一种基于 IP 核的嵌入式系统设计技术**，一个 MPU 或 DSP 核心与其它功能模块在处理器芯片内部形成系统，构成SoC
- 需要时，将原来的IP Core转移到新系统**或只更改一小部分电路，就可实现所需要的功能**，从而可以高效率地**缩短硬件产品的开发周期，降低开发的复杂度


## 嵌入式处理器与X86

| 比较点     | X86                                       | 嵌入式处理器                                    |
| ------- | ----------------------------------------- | ----------------------------------------- |
| 组成      | ALU、MMU、片内Cache，片内资源有限，其他功能需要扩展           | ALU、MMU、片内Cache，集成网卡、USB等控制器              |
| 指令系统    | CISC(`Complex Instruction Set Computing`) | RISC(`Reduced Instruction Set Computing`) |
| I/O编址方式 | 独立编址(计组)                                  | 统一编址(计组)                                  |
| 系统存储    | 硬盘，需要时调入内存                                | Flash/eMMC，启动后全部加载                        |
## 交叉编译

- 交叉编译，就是**在一个平台上生成另一个平台上的可执行代码**（在主机上生成目标板上可执行的代码）。
- 交叉调试，又叫远程调试，调试器和被调试的程序运行在不同的机器上。调试器运行在PC或工作站上，而被调试程序运行在各式的专用目标机上。
- 嵌入式软件开发编码完成后，要进行编译和链接以生成可执行代码。但是，在开发过程中设计人员普遍使用Intel的x86系列CPU的计算机进行开发，而目标环境的处理芯片却是多种多样的，如ARM DSP PowerPC DragonBall系列等，这就要求开发机上的编译器能支持交叉编译。
- 交叉编译链接生成两种类型的可执行文件：调试用的可执行文件和固化的可执行文件。


## 哈佛结构和冯诺依曼结构

### 哈佛结构

- **程序和数据存储在不同的存储空间**，程序存储空间和数据存储空间是两个相互独立的存储空间，**每个存储空间独立编址，由不同的总线访问**。

### 冯诺依曼结构

- **将指令、数据存储在同一个存储器中，统一编址，由同一总线访问**，依靠指令计数器提供的地址来区分是指令还是数据。取指令和取数据都访问统一存储器，数据吞吐率低。

## MCU和SoC

> MCU(Micro Control Unit)：微控器，大多是时候指单片机。
> 
> SoC（System on a Chip）：片上系统，系统级芯片。

## CISC和RISC

> CISC（Complex Instruction Set Computer）：复杂指令集计算机，**指令集庞大，指令长度不固定，指令执行周期有长有短**。实现复杂，但是它**单条指令效率更高**。
> 
> RISC（Reduced Instruction Set Computer）：精简指令集计算机，优先选取使用频率最高的简单指令,避免复杂指令，**将指令长度固定，指令格式和寻址方式种类减少**。

整个指令集中，只有约20％的指令常常会被使用到，大约占了整个程序的80％；剩余80％的指令，只占了整个程序的20％。

- CISC体系由于指令集庞大，**指令长度不固定**，**指令执行周期有长有短**，使指令译码和流水线的实现在硬件上非常复杂，给芯片的设计开发和成本的降低带来了极大困难。具有大量的指令和寻址方式，80%的程序只使用20%的指令，大多数程序只使用少量的指令就能够运行。
- RISC在通道中只包含最有用的指令，确保数据通道快速执行每一条指令，使CPU硬件结构设计变得更为简单。

## ARM处理器

> **ARM是一种RSIC处理器**，是Advanced RISC Machines的缩写。

1. **ARM7/9/11系列处理器**：是传统的ARM处理器，ARM7通常没有MMU，适用于低端应用，ARM11带有多媒体支持，适用于高端应用，ARM9介于二者之间
2. **Cortex-A系列处理器**：**定位高端**，用于**高性能**的开发应用平台，面向尖端的基于虚拟内存的操作系统和用户应用，**特点是**具有MMU和Cache，高频，高性能，高功耗
3. **Cortex-M系列处理器**：定位低端，单片机风格系统，是针对低功耗的微控制器，特点是没有任何RAM等记忆硬件。
#### ARM处理器特性

- 支持**16位指令集Thumb**，可**压缩代码尺寸40%**
- 可提供 `SIMD(Single Instruction Multiple Data)` 功能，将**语音及图像的处理功能提高到了4 倍**
- **支持 DSP(Digital Signal Processing) 指令**，对于音频 DSP 应用提高 **70%**
- **含有 Java 加速器 Jazelle**，**速度提高了8倍**，**功耗降低 20%**

### 多总线系统AMBA

> ARM公司为单个或者多个ARM处理器芯核提供的独立总线规格说明。英文全称是`Advanced Microcontroller Bus Architecture`


