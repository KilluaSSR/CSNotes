> **...本文施工中...**
# 前置

- 有一个`exe`文件。为了方便起见，就用`Hello World`吧。用`C`语言写一个程序并编译成`exe`即可。什么不会写？我给你写好了。不会编译的话我已经替你编译好了。

```C
#include <stdio.h>
int main(){
    printf("Hello, World");
    return 0;
}
```

- 装一下`010 Editor`。分析的时候需要用到。
- 用你的`010 Editor`打开我们的`Hello World.exe`。你会看到如下场景。让我们往下看。那里有个列表。第一行是 `DOS Header`那个。
![[Pasted image 20250707175430.png]]

- 点击表格中的某个结构，`010 Editor`会帮你找到他的位置的。

- 好啦让我们开始吧。

# PE结构部分

## DOS头

> 相信你看到了 `DOS Header`这里。程序存储在硬盘中的前 64 字节就是 DOS 头。你应该已经发现了`Size`那里写了`40h`。这是`16进制的40`，换算成十进制就是 $4*16 + 0*1 = 64$ 。非常简单。

它是 MSDOS时期的产物。在现在 Windows 操作系统中，DOS头中大多数内容已经没有意义了。有用的只有两个部分：`MZSignature`和`AddressOfNewExeHeader`。第一个和最后一个。

![[Pasted image 20250707180247.png]]

除此之外中间的所有内容你都可以随便修改，只有这两个不行。

- `MZSignature`：16进制下一定是`4D 5A`，对应的`ASCII`字符一定是`MZ`。这是PE文件的作者的名字简写。
- `AddressOfNewExeHeader`：这是一个偏移量，指向PE文件真正开始的地方。值得一提的是，我这里的值是`80 00 00 00`，那么你应该怎么读呢？实际上你应该从右往左看`00000080`。那么如果我这里的是`71 A1 22 35`，你应该找哪个地址呢？答案是`3522A171`。

## DOS存根

这部分数据在现代的32/64位操作系统是无效的。它的长度不固定，数据范围由`AddressOfNewExeHeader`决定。如果在 DOS 系统执行这个可执行文件，就会输出 DOS存根的内容，并不会执行后面的内容了。

## NT Header

![[Pasted image 20250707181856.png]]

> 点开 `NT Header`字段，你会发现有三个内容：`Signature`, `FileHeader`, `OptionalHeader`。其中第一个部分很简单，16进制下的数据是`50 45 00 00 `，也就是 `PE`。后面的内容就比较多了。

- 首先进入 `FileHeader`：
	- 第一项是`Machine`。我这里的值是`AMD64`，意思是这个程序可以在 x64 操作系统运行。
	- 第二项 `NumberOfSections`，我的值是 18。意思是有18个节表。什么是节表呢？我们一会就会说到了。
	- 接下来的内容都不怎么重要，直到：SizeOfOptionalHeader。它的值代表接下来的 OptionalHeader 的大小。
- 然后看看`OptionalHeader`：
	- 第一个重要的内容是`AddressOfEntryPoint` ，意思是程序的入口点。它的值是基于内存的**偏移地址**。
	- 第二个重要的是 `ImageBase`。它是程序的基地址。因此，运行程序的时候，需要找第一个指令的地方是 `基地址 + 偏移地址`。根据截图中的数据，是`140001125h`。聪明的你应该发现了如果两个可执行文件的地址可能相同。因此是有基址重定位的。基址重定位是指将 lmageBase 基址转换为实际的内存地址。如果两个 PE 文件的 lmageBase 都为 0x400000 ，则在基址重定位后，它们的内存地址不会相同。如果第一个 PE 文件的大小为 1MB ，则它的实际内存地址将是 0x400000 到 0x4FFFFF 之间。第二个 PE 文件的实际内存地址将是 0x500000 到 0x5FFFFF 之间。因此，即使两个 PE 文件的 lmageBase 都为 0x**400000 ，它们在内存中的地址也不会相同，因此不会发生数据覆盖。以及，如果开启了地址空间随机化，这个值就不再有参考意义了。**
	-  接着是 `SizeOfImage`：这个值代表着程序被加载到内存中的大小
	- `SizeOfHeaders`：代表着文件头的大小，我这里的值是`600h`，意味着从`000600`开始就是 PE 文件的数据内容了。

## SectionHeaders

![[Pasted image 20250707183637.png]]

> 聪明的你一定发现了这里有 18 个 SectionHeaders。这个 18 就是 `NumberOfSections` 里的那个18。点开看会发现许多节表。
- `.text`这是指令节表