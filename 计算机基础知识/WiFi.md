
## 认证方法

在 WiFi 网络中常用的主要认证系统有两种：开放系统认证（Open System Authentication）和共享密钥认证（Shared Key Authentication）。

![[Pasted image 20250509003853.png]]


- 开放系统认证直接明了，不需要任何共享密钥或凭据即可进行初始访问。这类认证通常用于开放网络，无需密码即可连接，允许任何设备在未经事先验证的情况下连接到网络。
- 共享密钥认证，顾名思义，涉及使用一个共享密钥。在这种系统中，客户端和接入点通过基于共享密钥计算挑战-响应机制来验证彼此的身份

虽然存在许多其他方法，尤其是在企业环境或使用 WPA3 和增强开放等高级协议时，但这两种方法是最普遍的。


## 开放系统认证

顾名思义，开放系统认证不需要任何共享密钥或凭据。这种认证类型通常用于不需要密码的开放网络。对于开放系统认证，它通常遵循以下顺序： 
1. 客户端（站点）向接入点发送认证请求以开始认证过程。 
2. 接入点随后向客户端发送认证响应，表明认证是否被接受。 
3. 客户端然后向接入点发送关联请求。 
4. 接入点随后用关联响应回应，表明客户端是否可以保持连接。

![[Pasted image 20250509003858.png]]

如上图所示，开放系统认证不需要任何凭据或认证。设备可以直接连接到网络而无需输入密码，这对于公共网络或访客网络来说很方便，因为易于访问是优先考虑的事项。 虽然开放系统认证对于公共网络或访客网络很方便，但共享密钥认证通过确保只有拥有正确密钥的设备才能访问网络，提供了额外的安全层。

## 共享密钥认证 

共享密钥认证确实涉及一个共享密钥，顾名思义。在这种认证系统中，客户端和接入点通过计算一个挑战来证明它们的身份。这种方法通常与有线等效隐私（WEP）和 Wi-Fi 保护访问（WPA）相关联。它通过使用预共享密钥提供基本级别的安全性。

![[Pasted image 20250509003902.png]]

### 使用 WEP 进行认证 

1. 首先，客户端向接入点发送认证请求。
2. 接入点然后用包含给客户端的文本的自定义认证响应进行回应。
3. 客户端然后用 WEP 密钥加密的文本进行回应。 
4. AP 然后解密此挑战并发送回成功或失败的指示。


![[Pasted image 20250509003906.png]]

### 使用 WPA 进行认证

另一方面，WPA 利用一种包含四次握手的认证形式。通常，这取代了关联过程，代之以更详细的验证，在 WPA3 的情况下，认证部分对于成对密钥生成来说甚至更复杂。从高层来看，这按以下方式执行。 
1. 认证请求：客户端向 AP 发送认证请求以启动认证过程。 
2. 认证响应：AP 用认证响应进行回应，表明已准备好继续认证。
3. 成对密钥生成：客户端和 AP 然后根据 PSK（密码）计算 PMK。 
4. 四次握手：客户端和接入点然后经历四次握手的每个步骤，这涉及 nonce 交换、派生以及其他验证客户端和 AP 确实知道 PSK 的操作



![[Pasted image 20250509003913.png]]

- 共享密钥认证类型还包括 WPA3，这是最新、最安全的 WiFi 安全标准。WPA3 引入了对其前身的重要改进，包括更强大的加密和增强的抗暴力攻击保护。其关键特性之一是对等方同时认证（Simultaneous Authentication of Equals, SAE），它取代了 WPA2 中使用的预共享密钥（PSK）方法，为密码和个人数据会话提供了更好的保护。 
- 尽管有其优点，但由于硬件限制，WPA3 的普及速度较慢。许多现有设备不支持 WPA3，需要固件更新或更换才能兼容。这在拥有大量旧设备的环中构成了广泛实施的障碍。因此，虽然 WPA3 提供了卓越的安全性，但其使用尚未普及，许多网络仍然依赖于 WPA2 等旧标准，直到必要的硬件升级变得更容易获得和负担得起。


## 802.11 帧和类型

在 802.11 通信中，针对不同的操作使用了几种不同的帧类型。这些操作都是连接周期的一部分，也是这些无线网络的标准通信方式。我们的许多攻击都利用了数据包构造/伪造技术。我们通过伪造这些相同的帧来执行诸如通过解除认证/解除关联请求将客户端设备从网络中断开的操作。

### IEEE 802.11 MAC 帧

所有 802.11 帧都使用 MAC 帧。此帧是客户端和接入点之间甚至在自组网中执行的所有其他字段和操作的基础。MAC 数据帧由 9 个字段组成。


|                 **字段**                 |                                 **描述**                                 |
| :------------------------------------: | :--------------------------------------------------------------------: |
|          帧控制 (Frame Control)           |             此字段包含大量信息，例如类型、子类型、协议版本、到 DS（分布式系统）、来自 DS、顺序等。             |
|         持续时间/ID (Duration/ID)          |                          此 ID 明确了无线介质被占用的时间量。                          |
| 地址 1, 2, 3, 4 (Address 1, 2, 3, and 4) | 这些字段明确了通信中涉及的 MAC 地址，但它们可能根据帧的来源具有不同的含义。这些通常包括接入点的 BSSID 和客户端 MAC 地址等。 |
|               序列控制 (SC)                |                         序列控制字段提供了额外的能力以防止重复帧。                          |
|               数据 (Data)                |                        简单来说，此字段负责发送方传输给接收方的数据。                         |
|              循环冗余校验 (CRC)              |                       循环冗余校验包含一个用于错误检测的 32 位校验和。                       |

#### IEEE 802.11 帧类型

IEEE 帧可以根据其功能和所涉及的操作分为不同的类别。一般来说，除了其他一些类型外，我们有以下主要类型。这些代码可以在我们过滤 Wireshark 流量时提供帮助。

1. 管理帧 (Management) (00)：这些帧用于管理和控制，允许接入点和客户端控制活动连接。

2. 控制帧 (Control) (01)：控制帧用于管理 Wi-Fi 网络内数据帧的传输和接收。我们可以将它们视为一种质量控制。

3. 数据帧 (Data) (10)：数据帧用于包含要传输的数据。

##### 管理帧子类型

如果我们在 Wireshark 中过滤它们，我们会指定类型 `00` 和以下子类型：

- 信标帧 (Beacon Frames) (1000)
- 探测请求 (Probe Request) (0100) 和探测响应 (Probe Response) (0101)
- 认证请求和响应 (Authentication Request and Response) (1011)
- 关联/重新关联请求和响应 (Association/Reassociation Request and Responses) (0000, 0001, 0010, 0011)
- 解除关联/解除认证 (Disassociation/Deauthentication) (1010, 1100)

1. 信标帧
    
    信标帧主要由接入点用于向客户端或站点广播其存在。它包含诸如支持的加密算法、认证类型、其 SSID 和支持的数据速率等信息。
    
2. 探测请求和响应
    
    探测请求和响应过程的存在是为了允许客户端发现附近的接入点。简单来说，无论网络是否隐藏，客户端都会发送带有接入点 SSID 的探测请求。接入点然后会用关于自身的信息回应客户端。
    
3. 认证请求和响应
    
    客户端向接入点发送认证请求以开始连接过程。这些帧主要用于向接入点标识客户端。
    
4. 关联/重新关联请求
    
    在发送认证请求并经历认证过程后，客户端向接入点发送关联请求。接入点然后用关联响应进行回应，表明客户端是否能够与其关联。
    
5. 解除关联/解除认证帧
    
    解除关联和解除认证帧从接入点发送到客户端。类似于它们的逆向帧（关联和认证），它们旨在终止接入点和客户端之间的连接。这些帧还包含所谓的原因代码。此原因代码指示客户端为何被从接入点断开连接。在 Wi-Fi 渗透测试工作中，我们利用构造这些帧进行许多握手捕获和基于拒绝服务的攻击。
    

#### 连接周期

现在，我们已经回顾了 IEEE 802.11 帧类型和管理帧子类型，接下来我们检查客户端和接入点之间典型的连接过程，即连接周期（connection cycle）。我们将重点关注基本的 WPA2 认证，尽管此过程可能因使用的 Wi-Fi 标准而异。然而，一般的连接周期遵循以下顺序。

1. 信标帧 (Beacon Frames)
2. 探测请求和响应 (Probe Request and Response)
3. 认证请求和响应 (Authentication Request and Response)
4. 关联请求和响应 (Association Request and Response)
5. 某种形式的握手或其他安全机制 (Some form of handshake or other security mechanism)
6. 解除关联/解除认证 (Disassociation/Deauthentication)

为了更好地理解此过程，可以在 Wireshark 中检查原始网络流量。成功捕获有效握手后，可以在 Wireshark 中打开捕获文件进行详细分析。

可以使用以下 Wireshark 过滤器识别来自接入点的信标帧：
![[Pasted image 20250509004942.png]]
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 8)

可以使用以下 Wireshark 过滤器识别来自接入点的探测请求帧：
![[Pasted image 20250509004947.png]]
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 4)

可以使用以下 Wireshark 过滤器识别来自接入点的探测响应帧：
![[Pasted image 20250509004950.png]]
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 5)

可以使用以下 Wireshark 过滤器观察客户端和接入点之间的认证过程：
![[Pasted image 20250509004954.png]]
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 11)

认证过程完成后，可以使用以下 Wireshark 过滤器查看站点的关联请求：
![[Pasted image 20250509004958.png]]
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 0)

可以使用以下 Wireshark 过滤器查看接入点的关联响应：
![[Pasted image 20250509005002.png]]
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 1)

如果示例网络使用 WPA2，可以使用以下 Wireshark 过滤器查看 EAPOL（握手）帧：
![[Pasted image 20250509005018.png]]
eapol

连接过程完成后，可以通过识别由哪一方（客户端或接入点）发起断开连接来查看连接的终止。可以使用以下 Wireshark 过滤器捕获解除关联帧 (10) 或解除认证帧 (12)：
![[Pasted image 20250509005025.png]]
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 12) or (wlan.fc.type_subtype == 10)

现在我们对帧的类型有了一些了解，下一节我们将探讨不同的认证方法，并介绍客户端和接入点之间的基本连接周期。


