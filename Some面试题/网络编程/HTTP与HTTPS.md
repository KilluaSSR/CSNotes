# HTTP与HTTPS

## HTTP协议基础

### 定义与特点
- **HTTP**：超文本传输协议，应用层协议
- **默认端口**：80
- **传输方式**：明文传输，数据未加密
- **安全性**：容易被窃听、篡改，不适合传输敏感信息

### 工作流程
1. 建立TCP连接（三次握手）
2. 发送HTTP请求
3. 服务器处理并返回响应
4. 关闭TCP连接

## HTTPS协议详解

### 定义与特点
- **HTTPS**：HTTP + SSL/TLS，在HTTP基础上加入加密层
- **默认端口**：443
- **传输方式**：加密传输
- **安全性**：提供数据加密、身份认证、数据完整性保护

### 加密机制

#### 对称加密
- **特点**：加密解密使用同一密钥
- **优点**：速度快，效率高，适合大数据量
- **缺点**：密钥传输安全问题，密钥管理困难
- **常见算法**：AES、DES、3DES

#### 非对称加密
- **特点**：公钥加密，私钥解密（或反之）
- **优点**：解决密钥传输问题
- **缺点**：速度慢，计算量大
- **常见算法**：RSA、ECDSA

#### 混合加密（HTTPS采用）

- 用非对称加密传输对称加密的密钥
- 用对称加密传输具体数据
- 兼顾安全性和效率

## HTTPS握手过程详解（重点）

### 完整SSL/TLS握手流程

#### 第一阶段：协商加密算法                                                                                           
1. **ClientHello**
   - 客户端发送支持的TLS版本
   - 支持的加密套件列表（密码套件）
   - 客户端随机数（Client Random）
   - 支持的压缩方法

2. **ServerHello**
   - 服务器选择TLS版本
   - 选择加密套件
   - 服务器随机数（Server Random）
   - 会话ID

#### 第二阶段：服务器身份验证
3. **Certificate**
   - 服务器发送数字证书
   - 证书包含服务器公钥
   - 证书链（可选）

4. **ServerKeyExchange**（可选）
   - 当证书中的公钥不能用于密钥交换时发送
   - 包含密钥交换所需的额外参数

5. **CertificateRequest**（可选）
   - 服务器要求客户端提供证书
   - 用于双向认证

6. **ServerHelloDone**
   - 表示服务器Hello阶段结束

#### 第三阶段：客户端响应
7. **Certificate**（可选）
   - 客户端发送自己的证书（双向认证时）

8. **ClientKeyExchange**
   - 客户端生成预主密钥（Pre-Master Secret）
   - 用服务器公钥加密预主密钥发送给服务器

9. **CertificateVerify**（可选）
   - 客户端证书的数字签名（双向认证时）

#### 第四阶段：完成握手
10. **ChangeCipherSpec**（客户端）
    - 通知服务器后续消息将使用协商的密钥加密

11. **Finished**（客户端）
    - 包含整个握手过程的哈希值
    - 用协商的密钥加密

12. **ChangeCipherSpec**（服务器）
    - 服务器确认使用新的加密参数

13. **Finished**（服务器）
    - 服务器发送握手完成消息
    - 握手成功完成

### 密钥生成过程

#### 主密钥生成
```
Master Secret = PRF(Pre-Master Secret, "master secret", 
                   Client Random + Server Random)
```

#### 会话密钥生成
从Master Secret派生出：
- 客户端写入密钥（加密客户端发送的数据）
- 服务器写入密钥（加密服务器发送的数据）
- 客户端写入MAC密钥（客户端消息认证）
- 服务器写入MAC密钥（服务器消息认证）

## HTTPS连接机制

### 连接建立过程

1. **DNS解析**：将域名解析为IP地址
2. **TCP三次握手**：建立TCP连接（80端口→443端口）
3. **TLS握手**：建立安全连接（上述13步）
4. **HTTP请求/响应**：在加密隧道中传输数据

### 连接复用机制

#### HTTP Keep-Alive
- 复用TCP连接，避免重复握手
- 减少连接建立和关闭的开销
- 在HTTPS中同样适用

#### TLS Session Resumption

1. **Session ID机制**
   - 服务器缓存会话信息
   - 客户端重连时发送Session ID
   - 跳过完整握手，直接使用缓存的密钥

2. **Session Ticket机制**
   - 服务器将会话信息加密发给客户端
   - 客户端重连时发送加密的Session Ticket
   - 服务器解密恢复会话

#### HTTP/2 over HTTPS
- 多路复用：单个连接处理多个请求
- 二进制分帧：提高传输效率
- 服务器推送：主动推送资源

### 证书验证机制

#### 证书链验证

1. **根证书**：操作系统/浏览器内置的可信根证书
2. **中间证书**：由根证书签发的中间CA证书
3. **服务器证书**：由中间CA签发的网站证书

#### 验证步骤
1. **证书链完整性**：验证从根证书到服务器证书的完整链路
2. **数字签名**：验证每级证书的数字签名
3. **有效期**：检查证书是否过期
4. **域名匹配**：验证证书中的域名与访问域名一致
5. **撤销状态**：检查CRL或OCSP验证证书是否被撤销

## HTTP vs HTTPS 核心区别

| 方面  | HTTP       | HTTPS               |
| --- | ---------- | ------------------- |
| 安全性 | 明文传输，易被窃听  | 加密传输，安全性高           |
| 端口  | 80         | 443                 |
| 证书  | 不需要        | 需要CA证书              |
| 速度  | 快（3个包建立连接） | 慢（3个TCP包+最多13个TLS包） |
| 成本  | 低          | 高（证书费用+服务器资源）       |
| SEO | 一般         | 搜索引擎优先收录            |

## GET vs POST 区别

### 表面区别
- **参数位置**：GET在URL中，POST在请求体中
- **缓存**：GET会被浏览器缓存，POST不会
- **历史记录**：GET参数保留在历史记录，POST不会
- **长度限制**：GET有URL长度限制，POST理论上无限制
- **安全性**：GET参数暴露在URL，POST相对安全
- **编码**：GET只支持ASCII，POST支持多种编码

### 本质区别
- **从TCP角度**：GET和POST本质上没有区别，都是TCP连接
- **HTTP规范**：定义了不同的语义和使用场景
- **浏览器实现**：浏览器对两者有不同的处理方式

## Q & A Time!

### 1. HTTPS如何防止中间人攻击？

- **数字证书验证**：确保服务器身份真实性
- **公钥加密**：防止密钥在传输过程中被窃取
- **数字签名**：防止证书被伪造
- **证书链验证**：通过可信第三方CA建立信任

### 2. 为什么HTTPS比HTTP慢？
- **额外握手**：需要TLS握手过程（最多13个包）
- **加密解密**：需要额外的CPU计算资源
- **证书验证**：需要验证证书链的时间
- **密钥协商**：复杂的密钥交换过程

### 3. HTTPS的性能优化方案

- **Session Resumption**：复用会话减少握手
- **OCSP Stapling**：服务器预先获取证书状态
- **HTTP/2**：多路复用提高效率
- **TLS 1.3**：简化握手流程（只需1-RTT）

### 4. TLS 1.2 vs TLS 1.3 的区别
- **握手次数**：1.3只需1次往返（1-RTT），1.2需要2次往返
- **加密算法**：1.3移除了不安全的加密算法
- **0-RTT**：1.3支持0-RTT恢复连接
- **Perfect Forward Secrecy**：1.3强制使用前向安全

### 5. 常见的HTTPS攻击方式
- **SSL剥离攻击**：将HTTPS降级为HTTP
- **证书欺骗**：使用伪造的证书
- **弱加密算法**：利用过时的加密算法漏洞
- **中间人攻击**：在证书验证环节插入恶意证书

### 6. 什么时候必须用HTTPS？
- 涉及用户隐私信息
- 金融交易
- 登录认证
- 搜索引擎优化需求
- 现代Web API要求（如Geolocation、Camera等）

## 总结
- **HTTP**：简单快速，适合一般信息传输
- **HTTPS**：安全可靠，适合敏感信息传输
- **选择原则**：根据数据敏感性和性能要求决定
- **发展趋势**：HTTPS已成为主流，主要浏览器开始标记HTTP为"不安全"
- **关键理解**：HTTPS = HTTP + TLS，重点在于理解TLS的握手过程和加密机制